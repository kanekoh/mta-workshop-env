---
# Tasks for waiting for OpenShift GitOps Operator to be ready

- name: Wait for CSV (ClusterServiceVersion) to be created
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    namespace: "{{ openshift_gitops.operator_namespace }}"
    label_selectors:
      - "operators.coreos.com/{{ openshift_gitops.operator_name }}.{{ openshift_gitops.operator_namespace }}"
  register: csv_result
  until: csv_result.resources | length > 0
  retries: 30
  delay: 10
  failed_when: false

- name: Wait for CSV to be in Succeeded phase
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    namespace: "{{ openshift_gitops.operator_namespace }}"
    name: "{{ csv_result.resources[0].metadata.name }}"
  register: csv_status
  until: csv_status.resources[0].status.phase == "Succeeded"
  retries: 30
  delay: 10

- name: Display CSV status
  debug:
    msg: "OpenShift GitOps Operator CSV is in {{ csv_status.resources[0].status.phase }} phase"

- name: Wait for ArgoCD namespace to be created
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ openshift_gitops.argocd_namespace }}"
  register: argocd_namespace
  until: argocd_namespace.resources | length > 0
  retries: 20
  delay: 10
  failed_when: false

- name: Display ArgoCD namespace status
  debug:
    msg: "ArgoCD namespace {{ openshift_gitops.argocd_namespace }} {{ 'exists' if argocd_namespace.resources | length > 0 else 'not yet created' }}"

