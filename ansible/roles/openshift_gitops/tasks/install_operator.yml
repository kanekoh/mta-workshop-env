---
# Tasks for installing OpenShift GitOps Operator

- name: Check if OpenShift GitOps Operator is already installed
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    namespace: "{{ openshift_gitops.operator_namespace }}"
    name: "{{ openshift_gitops.operator_name }}"
  register: operator_subscription
  failed_when: false
  changed_when: false

- name: Create Namespace for Operator if it doesn't exist
  kubernetes.core.k8s:
    name: "{{ openshift_gitops.operator_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
    definition:
      metadata:
        name: "{{ openshift_gitops.operator_namespace }}"
        labels:
          openshift.io/cluster-monitoring: "true"
  when: operator_subscription.resources | length == 0
  register: namespace_result

- name: Add cluster-monitoring label to existing Namespace
  kubernetes.core.k8s:
    name: "{{ openshift_gitops.operator_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
    definition:
      metadata:
        name: "{{ openshift_gitops.operator_namespace }}"
        labels:
          openshift.io/cluster-monitoring: "true"
  when: operator_subscription.resources | length > 0

- name: Create OperatorGroup for OpenShift GitOps Operator
  kubernetes.core.k8s:
    name: openshift-gitops-operator-group
    namespace: "{{ openshift_gitops.operator_namespace }}"
    api_version: operators.coreos.com/v1
    kind: OperatorGroup
    state: present
    definition:
      spec:
        targetNamespaces: []
  when: operator_subscription.resources | length == 0

- name: Create Subscription for OpenShift GitOps Operator
  kubernetes.core.k8s:
    name: "{{ openshift_gitops.operator_name }}"
    namespace: "{{ openshift_gitops.operator_namespace }}"
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    state: present
    definition:
      spec:
        channel: "{{ openshift_gitops.operator_channel }}"
        name: "{{ openshift_gitops.operator_name }}"
        source: "{{ openshift_gitops.operator_source }}"
        sourceNamespace: openshift-marketplace
        installPlanApproval: Automatic
  when: operator_subscription.resources | length == 0
  register: subscription_result

- name: Display subscription creation result
  debug:
    msg: "OpenShift GitOps Operator subscription {{ 'created' if subscription_result.changed else 'already exists' }}"

