---
# Tasks for configuring RHACM Policies using PolicyGenerator

- name: Ensure PolicyGenerator CRD exists
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: policygenerators.policy.open-cluster-management.io
  register: policygenerator_crd
  failed_when: false
  changed_when: false

- name: Wait for PolicyGenerator CRD to be available
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: policygenerators.policy.open-cluster-management.io
  register: policygenerator_crd_wait
  until: policygenerator_crd_wait.resources | length > 0
  retries: 20
  delay: 10
  failed_when: false

- name: Find PolicyGenerator definition files
  find:
    paths: "{{ playbook_dir }}/../../rhacm/policies/operators"
    patterns: "*-policygenerator.yaml"
    recurse: false
  register: policygenerator_files
  failed_when: false

- name: Apply PolicyGenerator definitions
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('file', item.path) | from_yaml }}"
  loop: "{{ policygenerator_files.files | default([]) }}"
  when: policygenerator_files.files | length > 0
  failed_when: false

- name: Display PolicyGenerator application status
  debug:
    msg: "PolicyGenerator definitions have been applied ({{ policygenerator_files.files | length | default(0) }} files)"

