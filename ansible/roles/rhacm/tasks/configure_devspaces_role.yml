---
# Tasks for configuring DevSpaces AWS Role ARN

- name: Get DevSpaces Role ARN from Terraform output
  command: terraform output -raw devspaces_role_arn
  args:
    chdir: "{{ playbook_dir }}/../../terraform/cluster"
  register: devspaces_role_arn_output
  changed_when: false
  failed_when: false

- name: Set DevSpaces Role ARN fact
  set_fact:
    devspaces_role_arn: "{{ devspaces_role_arn_output.stdout | default('') }}"
  when: devspaces_role_arn_output.rc == 0

- name: Create ConfigMap for DevSpaces AWS Role ARN
  kubernetes.core.k8s:
    name: devspaces-aws-role
    namespace: openshift-devspaces
    api_version: v1
    kind: ConfigMap
    state: present
    definition:
      metadata:
        name: devspaces-aws-role
        namespace: openshift-devspaces
      data:
        roleArn: "{{ devspaces_role_arn }}"
  when: devspaces_role_arn is defined and devspaces_role_arn | length > 0

- name: Wait for DevSpaces Subscription to be created by PolicyGenerator
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: devspaces
    namespace: openshift-devspaces
  register: devspaces_subscription
  until: devspaces_subscription.resources | length > 0
  retries: 30
  delay: 10
  failed_when: false
  when: devspaces_role_arn is defined and devspaces_role_arn | length > 0

- name: Update DevSpaces Subscription with ROLEARN
  kubernetes.core.k8s:
    state: present
    definition: "{{ devspaces_subscription.resources[0] | combine({'spec': devspaces_subscription.resources[0].spec | combine({'config': {'env': [{'name': 'ROLEARN', 'value': devspaces_role_arn}]}})}) }}"
  when:
    - devspaces_role_arn is defined
    - devspaces_role_arn | length > 0
    - devspaces_subscription.resources | length > 0

- name: Display DevSpaces Role ARN configuration status
  debug:
    msg: "DevSpaces Role ARN {{ 'configured' if (devspaces_role_arn is defined and devspaces_role_arn | length > 0) else 'not configured' }}: {{ devspaces_role_arn | default('N/A') }}"

