---
# Tasks for configuring this cluster as RHACM Hub

- name: Check if local-cluster ManagedCluster already exists
  kubernetes.core.k8s_info:
    api_version: cluster.open-cluster-management.io/v1
    kind: ManagedCluster
    name: local-cluster
  register: managed_cluster
  failed_when: false
  changed_when: false

- name: Wait for local-cluster ManagedCluster to be created (auto-created by RHACM)
  kubernetes.core.k8s_info:
    api_version: cluster.open-cluster-management.io/v1
    kind: ManagedCluster
    name: local-cluster
  register: managed_cluster_wait
  until: managed_cluster_wait.resources | length > 0
  retries: 30
  delay: 10
  failed_when: false

- name: Wait for local-cluster to be in Available condition
  kubernetes.core.k8s_info:
    api_version: cluster.open-cluster-management.io/v1
    kind: ManagedCluster
    name: local-cluster
  register: managed_cluster_status
  until: >
    managed_cluster_status.resources | length > 0 and
    managed_cluster_status.resources[0].status.conditions is defined and
    managed_cluster_status.resources[0].status.conditions | selectattr("type", "equalto", "ManagedClusterConditionAvailable") | selectattr("status", "equalto", "True") | list | length > 0
  retries: 30
  delay: 15

- name: Display ManagedCluster status
  debug:
    msg: "Local-cluster ManagedCluster is available"

