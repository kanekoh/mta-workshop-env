---
# Playbook for creating ConfigMaps with RoleARNs for Operators
- name: Setup Operator RoleARN ConfigMaps
  hosts: openshift
  gather_facts: true
  vars:
    cluster_info_file: "{{ playbook_dir }}/../cluster_info.json"
  
  tasks:
    - name: Verify cluster connection
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: default
      register: cluster_connection
      failed_when: false
    
    - name: Fail if cluster is not accessible
      fail:
        msg: "Cannot connect to OpenShift cluster. Please ensure you are logged in with 'oc login'."
      when: cluster_connection.failed | default(true)
    
    - name: Load cluster information from cluster_info.json
      set_fact:
        cluster_info: "{{ lookup('file', cluster_info_file) | from_json }}"
      when: cluster_info_file is defined
      register: cluster_info_result
      failed_when: false
    
    - name: Set RoleARN map and GitOps paths
      set_fact:
        rolearn_map: "{{ cluster_info.role_arns | default({}) }}"
        repo_root: "{{ playbook_dir }}/../.."
        gitops_env_name: "{{ gitops_env | default('mta') }}"
        gitops_apps_path: "{{ repo_root }}/gitops/environments/{{ gitops_env_name }}/apps"
      when:
        - cluster_info is defined

    - name: Create RoleARN ConfigMaps for selected Operators
      vars:
        rolearn_value: "{{ rolearn_map[op.rolearn_key] | default('') }}"
        app_path: "{{ gitops_apps_path }}/{{ op.app_file }}"
        subs_path: "{{ repo_root }}/{{ op.subs_path }}"
      block:
        - name: Check operator app exists in env
          stat:
            path: "{{ app_path }}"
          register: app_stat

        - name: Check operator subs.yaml exists
          stat:
            path: "{{ subs_path }}"
          register: subs_stat

        - name: Read operator subs.yaml
          slurp:
            path: "{{ subs_path }}"
          register: subs_file
          when: subs_stat.stat.exists | default(false)

        - name: Ensure operator namespace exists
          kubernetes.core.k8s:
            name: "{{ op.namespace }}"
            api_version: v1
            kind: Namespace
            state: present
          when:
            - app_stat.stat.exists | default(false)
            - (subs_file.content | default('') | b64decode) is search('ROLEARN')
            - rolearn_value | length > 0

        - name: Create ConfigMap for Operator RoleARN
          kubernetes.core.k8s:
            name: operator-rolearn
            namespace: "{{ op.namespace }}"
            api_version: v1
            kind: ConfigMap
            state: present
            definition:
              metadata:
                name: operator-rolearn
                namespace: "{{ op.namespace }}"
              data:
                rolearn: "{{ rolearn_value }}"
          when:
            - app_stat.stat.exists | default(false)
            - (subs_file.content | default('') | b64decode) is search('ROLEARN')
            - rolearn_value | length > 0
      loop: "{{ operator_rolearn_configmaps | default([]) }}"
      loop_control:
        loop_var: op
      when:
        - rolearn_map is defined
        - gitops_apps_path is defined

    - name: Display ConfigMap evaluation status
      debug:
        msg: "Operator RoleARN ConfigMap evaluation complete for gitops_env={{ gitops_env | default('mta') }}."

